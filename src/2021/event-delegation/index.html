<!DOCTYPE html>
<html>
	<head>
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<meta charset="utf-8" />
		
		<title>Event delegation In React</title>
	</head>
<body>
<h1>Event delegation In React</h1>

<p><strong>2021.11.30</strong></p>

<h2>ä»€ä¹ˆæ˜¯ Event delegation</h2>

<p>å…·ä½“å¯ä»¥çœ‹ä¸‹ <a href="https://davidwalsh.name/event-delegate">è¿™ç¯‡æ–‡æ¡£</a>ï¼Œæ–‡ä¸­ä¸¾çš„ç®€å•çš„ä¾‹å­ï¼Œæ¯”å¦‚ä½ æœ‰ä¸€ä¸ª listï¼Œåˆ—è¡¨é‡Œé¢æœ‰ 100 ä¸ª itemï¼Œå¦‚ä½•åœ¨ç‚¹å‡» item çš„æ—¶å€™ï¼Œæ‰“å° item çš„å†…å®¹å‘¢ï¼Ÿ</p>

<p>ä½ æœ‰ä¸¤ç§è§£å†³åŠæ³•ï¼Œ</p>

<p>ç¬¬ä¸€ç§ï¼šéå† list çš„æ—¶å€™ï¼Œç»™æ¯ä¸ª item è®¾ç½®ä¸€ä¸ª <code>onClick</code> event listener ï¼Œè¿™æ ·å°±ä¼šè®¾ç½® 100 ä¸ª event listenerï¼Œå½“ä½ ç§»é™¤ item çš„æ—¶å€™è¿˜éœ€è¦æ‰‹åŠ¨ç§»é™¤è¯¥ item çš„ event listenerï¼Œæ·»åŠ  item çš„æ—¶å€™ï¼Œéœ€è¦æ‰‹åŠ¨æ·»åŠ  event listenerï¼ŒğŸ˜¡</p>

<p>ç¬¬äºŒç§ï¼šç›´æ¥åœ¨ ul ä¸Šç›´æ¥åŠ  <strong>ä¸€ä¸ª</strong> <code>onClick</code> äº‹ä»¶å°±å®Œäº†ï¼Œå½“ä½ ç‚¹å‡» liï¼Œli çš„ <code>onClick</code> äº‹ä»¶ bubble åˆ° ul ä¸Šï¼Œul ç›´æ¥ä» event é‡Œçš„ target é‡Œè·å– li çš„å¼•ç”¨å†è·å–å¯¹åº”çš„å±æ€§å³å¯ï¼ˆä½¿ç”¨ <code>data-*</code> å±æ€§ä¹Ÿä¸é”™ï¼‰ï¼Œè¿™æ ·å°±ä¸ç”¨æ‹…å¿ƒæ·»åŠ /ç§»é™¤ item äº†ï¼Œå› ä¸ºä½ çš„ listener æ˜¯æŒ‚åœ¨ ul ä¸Šçš„ï¼‰ï¼ŒğŸ¥³</p>

<p>å½“ç„¶äº‹ä»¶å§”æ‰˜ä¹Ÿæœ‰ä¸¤ç§å®ç°æ–¹å¼ï¼Œä¸€ç§æ˜¯å†’æ³¡ï¼Œä¸€ç§æ˜¯æ•è·ï¼Œä»å…¼å®¹æ€§è€ƒè™‘ä¸€èˆ¬ä½¿ç”¨å†’æ³¡æ¨¡å‹ã€‚</p>

<h2>è°åœ¨ç”¨</h2>

<p><strong>React</strong></p>

<p>React ä»ç¬¬ä¸€ä¸ªç‰ˆæœ¬å°±ä½¿ç”¨ <strong>event delegation</strong> è¿™ç§è®¾è®¡æ¨¡å¼ã€‚</p>

<blockquote>
<p>React has been doing event delegation automatically since its first release. When a DOM event fires on the document, React figures out which component to call, and then the React event â€œbubblesâ€ upwards through your components. But behind the scenes, the native event has already bubbled up to the document level, where React installs its event handlers. - <a href="https://reactjs.org/blog/2020/08/10/react-v17-rc.html#changes-to-event-delegation">react official doc</a></p>
</blockquote>

<p>å°±åƒæˆ‘ä»¬ä¸€å¼€å§‹çš„ä¾‹å­ï¼Œæˆ‘ä»¬åœ¨ <strong>ul</strong> ä¸ŠæŒ‚äº†ä¸ª <code>click</code> çš„ event handler æ¥å¤„ç† <strong>li</strong> çš„ <code>onclick</code> äº‹ä»¶ï¼ŒReact ï¼ˆReact 17 ä¹‹å‰ï¼‰åˆ™æ˜¯åœ¨ <strong>document</strong> ä¸ŠæŒ‚çš„å¯¹åº”çš„ event type çš„ event listenerã€‚</p>

<h3>React 16</h3>

<p>åœ¨ React 17 ä¹‹å‰ï¼Œä¸€ç›´æ˜¯å°† event listener æŒ‚åœ¨ <strong>document</strong> ä¸Šçš„ï¼Œä½†æ˜¯è¿™æ ·ä¼šå¯¼è‡´ä¸€äº›é—®é¢˜ï¼Œæ¯”å¦‚ï¼Œ<code>e.stopPropagation()</code> â€œæœ‰æ—¶â€<a href="https://reactjs.org/blog/2020/08/10/react-v17-rc.html#changes-to-event-delegation">æ— æ•ˆçš„é—®é¢˜</a>ã€‚</p>

<p>å°±æ‹¿å¾ˆæ—©ä¹‹å‰ï¼ˆ4å¹´å‰ï¼‰atom editor å°±é‡åˆ°è¿‡ <a href="https://github.com/facebook/react/pull/8117">è¿™ä¸ªé—®é¢˜</a> ä¸¾ä¸ªä¾‹å­ï¼Œè¿™ä¸ªæ˜¯ç”±äºå¤šç‰ˆæœ¬çš„ react åµŒå¥—å¯¼è‡´çš„ <code>e.stopPropagation()</code> æ— æ•ˆï¼Œè¿™é‡Œå‚è€ƒäº†è¿™ä¸ªé—®é¢˜é‡Œçš„æµ‹è¯•ç”¨ä¾‹ï¼Œå†™äº†ä¸ª <a href="https://react-16-nest-react-16.netlify.app/">demo</a>ï¼Œä¸€èµ·æ¥çœ‹ä¸‹ï¼Œ</p>

<p>Demo é‡Œæ˜¯ä¸¤ä¸ªåµŒå¥—çš„ react dom treeï¼Œç‰ˆæœ¬éƒ½æ˜¯ 16ï¼Œä¸€ä¸ªæ˜¯ 16.13 ä¸€ä¸ªæ˜¯ 16.14ï¼Œ</p>

<pre><code class="code-highlighted code-html"><span class="syntax-all syntax-comment">&lt;!-- https://reactjs.org/docs/add-react-to-a-website.html --&gt;</span>
<span class="syntax-all syntax-comment">&lt;!-- https://codesandbox.io/s/amd-apploader-og1z5?file=/src/Apploader.js --&gt;</span>
<span class="syntax-all syntax-comment">&lt;!-- https://cdnjs.com/libraries/react-dom/16.13.0 --&gt;</span>

<span class="syntax-all syntax-comment">&lt;!-- è¿™ä¸ªæ˜¯æœŸæœ›çš„ç‰ˆæœ¬ ä½œè€…ä¿®æ”¹äº†ä»£ç  æŒ‚åœ¨ react root tree ä¸Šé¢äº† è€Œä¸æ˜¯ document ä¸Š--&gt;</span>
<span class="syntax-all syntax-comment">&lt;!-- http://fooo.fr/~vjeux/fb/vjeux-test/test-event-boundary.html  --&gt;</span>

<span class="syntax-all syntax-comment">&lt;!-- NOTE: æµ‹è¯•ä¸¤ä¸ª ä¸åŒç‰ˆæœ¬çš„ react åµŒå¥—åœ¨ä¸€èµ·çš„æ—¶å€™ stopPropgation çš„ bug --&gt;</span>
&lt;<span class="syntax-all syntax-tag">script</span> <span class="syntax-all syntax-entity">src</span>=<span class="syntax-all syntax-string">&quot;./require.min.js&quot;</span>&gt;&lt;/<span class="syntax-all syntax-tag">script</span>&gt;
&lt;<span class="syntax-all syntax-tag">script</span>&gt;
  <span class="syntax-all syntax-constant">window</span><span class="syntax-all syntax-keyword">.</span><span class="syntax-all syntax-parameter">require</span><span class="syntax-all syntax-keyword">.</span><span class="syntax-all syntax-variable">config</span>({
    <span class="syntax-all syntax-string">paths</span><span class="syntax-all syntax-constant">:</span> {
      <span class="syntax-all syntax-string">react</span><span class="syntax-all syntax-constant">:</span> <span class="syntax-all syntax-string">&quot;../react16.14.development&quot;</span>,
      <span class="syntax-all syntax-string">react2</span><span class="syntax-all syntax-constant">:</span> <span class="syntax-all syntax-string">&quot;./react.16.13.development&quot;</span>,
      <span class="syntax-all syntax-string">&quot;react-dom&quot;</span>: <span class="syntax-all syntax-string">&quot;./react-dom16.14.development&quot;</span>,
      <span class="syntax-all syntax-string">&quot;react-dom2&quot;</span>: <span class="syntax-all syntax-string">&quot;./react-dom16.13.development&quot;</span>,
    },
  });
&lt;/<span class="syntax-all syntax-tag">script</span>&gt;
&lt;<span class="syntax-all syntax-tag">div</span> <span class="syntax-all syntax-entity">id</span>=<span class="syntax-all syntax-string">&quot;root&quot;</span>&gt;&lt;/<span class="syntax-all syntax-tag">div</span>&gt;
&lt;<span class="syntax-all syntax-tag">script</span>&gt;
  <span class="syntax-all syntax-constant">window</span><span class="syntax-all syntax-keyword">.</span><span class="syntax-all syntax-variable">require</span>(
    [<span class="syntax-all syntax-string">&quot;react&quot;</span>, <span class="syntax-all syntax-string">&quot;react-dom&quot;</span>, <span class="syntax-all syntax-string">&quot;react2&quot;</span>, <span class="syntax-all syntax-string">&quot;react-dom2&quot;</span>],
    <span class="syntax-all syntax-keyword">function</span> (<span class="syntax-all syntax-parameter">React</span>, <span class="syntax-all syntax-parameter">ReactDOM</span>, <span class="syntax-all syntax-parameter">React2</span>, <span class="syntax-all syntax-parameter">ReactDOM2</span>) {
      <span class="syntax-all syntax-keyword">const</span> <span class="syntax-all syntax-parameter">e</span> <span class="syntax-all syntax-keyword">=</span> <span class="syntax-all syntax-parameter">React</span><span class="syntax-all syntax-keyword">.</span><span class="syntax-all syntax-parameter">createElement</span>;
      <span class="syntax-all syntax-keyword">const</span> <span class="syntax-all syntax-parameter">e2</span> <span class="syntax-all syntax-keyword">=</span> <span class="syntax-all syntax-parameter">React2</span><span class="syntax-all syntax-keyword">.</span><span class="syntax-all syntax-parameter">createElement</span>;

	  <span class="syntax-all syntax-comment">// è“è‰²ï¼ˆé‡Œé¢çš„ï¼‰
</span>      <span class="syntax-all syntax-keyword">class</span> <span class="syntax-all syntax-entity">InnerComponent</span> <span class="syntax-all syntax-keyword">extends</span> <span class="syntax-all syntax-parameter">React2</span><span class="syntax-all syntax-keyword">.</span><span class="syntax-all syntax-parameter">Component</span> {
        <span class="syntax-all syntax-entity">render</span>() {
          <span class="syntax-all syntax-keyword">return</span> <span class="syntax-all syntax-variable">e2</span>(
            <span class="syntax-all syntax-string">&quot;div&quot;</span>,
            {
              <span class="syntax-all syntax-entity">onClick</span>: (<span class="syntax-all syntax-parameter">e</span>) <span class="syntax-all syntax-keyword">=&gt;</span> {
                <span class="syntax-all syntax-parameter">e</span><span class="syntax-all syntax-keyword">.</span><span class="syntax-all syntax-variable">stopPropagation</span>();
                <span class="syntax-all syntax-constant">console</span><span class="syntax-all syntax-keyword">.</span><span class="syntax-all syntax-constant">log</span>(<span class="syntax-all syntax-string">&quot;innerOnClick&quot;</span>);
              },
              <span class="syntax-all syntax-string">style</span><span class="syntax-all syntax-constant">:</span> { <span class="syntax-all syntax-string">border</span><span class="syntax-all syntax-constant">:</span> <span class="syntax-all syntax-string">&quot;1px solid blue&quot;</span>, <span class="syntax-all syntax-string">padding</span><span class="syntax-all syntax-constant">:</span> <span class="syntax-all syntax-constant">50</span> },
            },
            <span class="syntax-all syntax-parameter">React2</span><span class="syntax-all syntax-keyword">.</span><span class="syntax-all syntax-variable">createElement</span>(<span class="syntax-all syntax-string">&quot;div&quot;</span>, {
              <span class="syntax-all syntax-string">className</span><span class="syntax-all syntax-constant">:</span> <span class="syntax-all syntax-string">&quot;inner&quot;</span>,
            })
          );
        }
      }

	  <span class="syntax-all syntax-comment">// çº¢è‰²ï¼ˆå¤–é¢çš„ï¼‰
</span>      <span class="syntax-all syntax-keyword">class</span> <span class="syntax-all syntax-entity">OuterComponent</span> <span class="syntax-all syntax-keyword">extends</span> <span class="syntax-all syntax-parameter">React</span><span class="syntax-all syntax-keyword">.</span><span class="syntax-all syntax-parameter">Component</span> {
        <span class="syntax-all syntax-parameter">componentDidMount</span> <span class="syntax-all syntax-keyword">=</span> <span class="syntax-all syntax-keyword">function</span> () {
          <span class="syntax-all syntax-comment">// React 16.13 
</span>          <span class="syntax-all syntax-parameter">ReactDOM2</span><span class="syntax-all syntax-keyword">.</span><span class="syntax-all syntax-variable">render</span>(
            <span class="syntax-all syntax-parameter">React2</span><span class="syntax-all syntax-keyword">.</span><span class="syntax-all syntax-variable">createElement</span>(<span class="syntax-all syntax-parameter">InnerComponent</span>),
            <span class="syntax-all syntax-constant">this</span><span class="syntax-all syntax-keyword">.</span><span class="syntax-all syntax-parameter">refs</span><span class="syntax-all syntax-keyword">.</span><span class="syntax-all syntax-parameter">inner</span>
          );
        };

        <span class="syntax-all syntax-entity">render</span>() {
          <span class="syntax-all syntax-keyword">return</span> <span class="syntax-all syntax-variable">e</span>(
            <span class="syntax-all syntax-string">&quot;div&quot;</span>,
            {
              <span class="syntax-all syntax-entity">onClick</span>: (<span class="syntax-all syntax-parameter">e</span>) <span class="syntax-all syntax-keyword">=&gt;</span> {
                <span class="syntax-all syntax-parameter">e</span><span class="syntax-all syntax-keyword">.</span><span class="syntax-all syntax-variable">stopPropagation</span>();
                <span class="syntax-all syntax-constant">console</span><span class="syntax-all syntax-keyword">.</span><span class="syntax-all syntax-constant">log</span>(<span class="syntax-all syntax-string">&quot;outerOnClick&quot;</span>);
              },
              <span class="syntax-all syntax-string">style</span><span class="syntax-all syntax-constant">:</span> { <span class="syntax-all syntax-string">border</span><span class="syntax-all syntax-constant">:</span> <span class="syntax-all syntax-string">&quot;1px solid red&quot;</span>, <span class="syntax-all syntax-string">padding</span><span class="syntax-all syntax-constant">:</span> <span class="syntax-all syntax-constant">20</span> },
            },
            <span class="syntax-all syntax-parameter">React</span><span class="syntax-all syntax-keyword">.</span><span class="syntax-all syntax-variable">createElement</span>(<span class="syntax-all syntax-string">&quot;div&quot;</span>, {
              <span class="syntax-all syntax-string">ref</span><span class="syntax-all syntax-constant">:</span> <span class="syntax-all syntax-string">&quot;inner&quot;</span>,
              <span class="syntax-all syntax-string">className</span><span class="syntax-all syntax-constant">:</span> <span class="syntax-all syntax-string">&quot;outer&quot;</span>,
            })
          );
        }
      }

      <span class="syntax-all syntax-parameter">ReactDOM</span><span class="syntax-all syntax-keyword">.</span><span class="syntax-all syntax-variable">render</span>(<span class="syntax-all syntax-variable">e</span>(<span class="syntax-all syntax-parameter">OuterComponent</span>), <span class="syntax-all syntax-constant">document</span><span class="syntax-all syntax-keyword">.</span><span class="syntax-all syntax-variable">getElementById</span>(<span class="syntax-all syntax-string">&quot;root&quot;</span>));
    }
  );
&lt;/<span class="syntax-all syntax-tag">script</span>&gt;</code></pre>

<figure><img src="DraggedImage.png"/></figure>

<p>ä¸¤ä¸ªæ¡†æ¡†éƒ½åŠ äº†ç‚¹å‡»äº‹ä»¶ï¼Œç‚¹å‡»äº‹ä»¶éƒ½è°ƒç”¨äº† <code>e.stopPropagation()</code> æƒ³è¦é˜»æ­¢å†’æ³¡ï¼Œä½ è§‰å¾—ä¼šå‘ç”Ÿä»€ä¹ˆï¼Ÿ</p>

<p>æ˜¯ä¸æ˜¯è§‰å¾—åªä¼šæ‰“å° â€œinnerOnClickâ€ ï¼Ÿå¯æ˜¯ä¸¤ä¸ªæ‰“å°éƒ½å‡ºæ¥äº†ï¼Œæ²¡æƒ³åˆ°å§ï¼Œæ˜¯ä¸æ˜¯å¾ˆå¥‡æ€ª ï¼Ÿï¼Ÿï¼Ÿ</p>

<figure><img src="DraggedImage-1.png"/></figure>

<p>ä¸ºä»€ä¹ˆå‘¢ï¼Ÿè¿™å°±å’Œ React çš„ <a href="https://reactjs.org/blog/2020/08/10/react-v17-rc.html#changes-to-event-delegation">event delegation</a> å®ç°æœ‰å…³äº†ã€‚</p>

<p>React DOM ä¼šåœ¨ <strong>document</strong> ä¸Šè®¾ç½®ä¸€ä¸ªæ€»çš„å¯¹åº” event type çš„å•ä¸ª event listenerï¼Œæ¯”å¦‚ï¼Œ<code>click</code> äº‹ä»¶çš„è¯ï¼Œ<code>document.addEventListener(&#39;click&#39;, eventHandler)</code>ï¼Œè¿™æ ·æ¥è¿›è¡Œäº‹ä»¶å§”æ‰˜ï¼ˆevent delegationï¼‰ï¼Œ</p>

<figure><img src="DraggedImage-2.png"/></figure>

<p>ä½ å¯ä»¥çœ‹åˆ°ï¼Œä¸¤ä¸ªç‰ˆæœ¬çš„ React DOM åˆ†åˆ«å¾€ <strong>document</strong> ä¸Šæ·»åŠ äº†ä¸€ä¸ª <code>click</code> çš„ event handlerï¼ˆåˆå§‹åŒ– fiber tree çš„æ—¶å€™ï¼Œæ ¹æ® fiber node ä¸Šçš„å±æ€§æ¥åˆ›å»ºå¯¹åº” event type çš„å•ä¸ª event listenerï¼‰ï¼Œä¸¤ä¸ªæ¡†æ¡†ä¹Ÿè¢«åŠ äº†ä¸€ä¸ªï¼ˆ<code>noop</code> å‡½æ•°ï¼Œå°±æ˜¯å•¥ä¹Ÿä¸åšçš„æ„æ€ï¼Œè¿™ä¸ªå…¶å®æ˜¯ç”¨æ¥è§£å†³çš„ iOS Safari çš„ä¸€ä¸ª <a href="https://github.com/facebook/react/issues/13635">bug</a> ç”¨çš„ï¼Œä½ å°±ç†è§£ä¸º <strong>æ¡†æ¡†</strong> æœ¬èº«å¹¶æ²¡æœ‰æ·»åŠ  <code>click</code> çš„ event listenerï¼‰ï¼Œ</p>

<p>ä½ ä¼šæƒ³ï¼Œæˆ‘ä»¬åœ¨å†™ React çš„ç»„ä»¶çš„æ—¶å€™ä¸æ˜¯ä¼šåœ¨ç»„ä»¶ä¸Šé¢å†™ä¸€ä¸ªè¡Œå†…çš„ <code>onClick</code> çš„ event listener å—ï¼Ÿ</p>

<p>æ˜¯çš„ï¼Œä½†æ˜¯è¿™ä¸ªè¡Œå†… <code>onClick</code> ä¸æ˜¯è¿™æ ·ç”¨çš„ã€‚</p>

<p>è¿˜è®°å¾—æˆ‘ä»¬è¯´çš„ React æœ‰ä¸€å¥—è‡ªå·±çš„ <a href="https://reactjs.org/blog/2020/08/10/react-v17-rc.html#changes-to-event-delegation">event delegation</a> æœºåˆ¶å—ï¼Ÿä½ çš„ <code>onClick</code> props æ˜¯ä¸ä¼šç›´æ¥åœ¨ DOM node èŠ‚ç‚¹ä¸Šç›´æ¥åˆ›å»º event listener çš„ï¼ŒReact DOM ä¼šä½¿ç”¨è¿™ä¸ª props å±æ€§åˆ©ç”¨ fiber tree æ¨¡æ‹Ÿå‡ºä¸€ä¸ªäº‹ä»¶é˜Ÿåˆ—ã€‚</p>

<p>æ•´ä¸ªæµç¨‹æ˜¯è¿™æ ·çš„ï¼Œå½“ä½ ç‚¹å‡»é‡Œé¢çš„è“è‰²æ¡†æ¡†çš„æ—¶å€™ï¼Œè§¦å‘äº†ä¸€ä¸ª <code>click</code> äº‹ä»¶ï¼Œç„¶åè¯¥äº‹ä»¶ï¼ˆeventï¼‰è¢«ä¸€è·¯å¾€ä¸Š bubbleï¼Œå› ä¸ºçº¢è‰²çš„æ¡†æ¡†ä¹Ÿæ˜¯åœ¨å¦ä¸€ä¸ª React DOM tree é‡Œï¼Œæ‰€ä»¥çº¢è‰²çš„æ¡†æ¡†ä¹Ÿæ²¡æœ‰ç‚¹å‡»äº‹ä»¶ï¼ˆé™¤äº†å…¼å®¹ç”¨çš„ <code>noop</code> çš„ä¸€ä¸ª click äº‹ä»¶ï¼‰ï¼Œç„¶åå…¶ä»–çš„ DOM node èŠ‚ç‚¹ä¸Šé¢ä¹Ÿæ²¡æœ‰è®¾ç½® click çš„ event listenerï¼Œæœ€åbubble åˆ°äº† <strong>document</strong> èŠ‚ç‚¹ï¼Œå› ä¸ºçº¢è‰²çš„æ¡†æ¡†æ‰€åœ¨çš„ React DOMæ˜¯å…ˆåˆå§‹åŒ–çš„ï¼Œè€Œè“è‰²çš„æ˜¯åé¢åˆå§‹åŒ–çš„ï¼ˆå› ä¸ºåœ¨çº¢è‰²æ¡†æ¡† mount åæ‰ mount çš„ï¼‰ï¼Œæ‰€ä»¥çº¢è‰²çš„æ¡†æ¡†ä¼šå…ˆåœ¨ <strong>document</strong> ä¸Šè®¾ç½® event listener çš„ï¼Œæ‰€ä»¥çº¢è‰²æ¡†æ¡†çš„ React DOM åœ¨ <strong>document</strong> ä¸Šè®¾ç½®çš„ click event listener ä¼šå…ˆè¢«è°ƒç”¨ï¼Œè°ƒç”¨çš„æ—¶å€™ï¼ŒReact DOM ä¼šæ ¹æ® <code>event</code> çš„ <em>target</em> å±æ€§è·å– DOM node èŠ‚ç‚¹å¼•ç”¨ï¼Œç„¶åæ‰¾åˆ°å¯¹åº”çš„ fiber nodeï¼Œå†çœ‹ä¸Šé¢æœ‰æ²¡æœ‰ <code>onClick</code> çš„ propsï¼Œæœ‰çš„è¯åŠ å…¥åˆ°å†…éƒ¨å¾…æ‰§è¡Œçš„ event handler queueï¼ˆäº‹ä»¶é˜Ÿåˆ—ï¼‰ é‡Œå»ï¼Œç„¶åå† traverse <em>target</em> çš„ DOM node èŠ‚ç‚¹çš„ parent DOM node èŠ‚ç‚¹ï¼Œå¯¹æ¯ä¸€ä¸ª parent DOM node ä¾æ¬¡æ‰¾åˆ°å…¶å¯¹åº”çš„ fiber nodeï¼Œç„¶åçœ‹æœ‰æ²¡æœ‰ <code>onClick</code> propsï¼Œæœ‰çš„è¯åŠ å…¥åˆ°äº‹ä»¶é˜Ÿåˆ—ï¼Œæ²¡æœ‰çš„è¯ç»§ç»­ traverseï¼Œç›´åˆ°åˆ° React DOM rootèŠ‚ç‚¹ï¼Œè¿™æ ·å°±æ¨¡æ‹Ÿå‡ºäº†åŸç”Ÿ DOM çš„ event çš„ bubble é€»è¾‘ï¼ˆcapture åŒç†ï¼‰ï¼Œç„¶åæŒ¨ä¸ªæ‰§è¡Œï¼Œå¦‚æœæœ‰å‘ç°æŸä¸ªè°ƒç”¨çš„ <code>onClick</code> event handler æœ‰ <code>e.stopPropagation()</code> é€»è¾‘çš„è¯ï¼ŒReact DOM ä¼šé¦–å…ˆåœ¨ <em>native event</em> ä¸Šè°ƒç”¨ <code>e.stopPropagation()</code>ï¼Œç„¶åå°†å†åœ¨åŒ…äº† <em>native event</em> ä¸€å±‚çš„ Synthetic Eventï¼ˆåˆæˆäº‹ä»¶ï¼‰ä¸Šçš„ <em> isDefaultPrevented</em> è®¾ä¸º <em>true</em>ï¼ˆ <code>this.isDefaultPrevented = functionThatReturnsTrue</code>ï¼‰ï¼Œè¿™æ · React DOM è‡ªå·±æ¨¡æ‹Ÿçš„äº‹ä»¶é˜Ÿåˆ—å°±å¯ä»¥æ ¹æ®è¿™ä¸ªå±æ€§æ¥æ¨¡æ‹Ÿæµè§ˆå™¨çš„ <code>stopPropagation</code> è¡Œä¸ºäº†ï¼Œ</p>

<pre><code class="code-highlighted code-js">    <span class="syntax-all syntax-comment">//`onClick` äº‹ä»¶çš„ `e.stopPropagation()` é€»è¾‘
</span>	<span class="syntax-all syntax-entity">stopPropagation</span>: <span class="syntax-all syntax-keyword">function</span> () {
      <span class="syntax-all syntax-keyword">var</span> <span class="syntax-all syntax-parameter">event</span> <span class="syntax-all syntax-keyword">=</span> <span class="syntax-all syntax-constant">this</span><span class="syntax-all syntax-keyword">.</span><span class="syntax-all syntax-parameter">nativeEvent</span>;

      <span class="syntax-all syntax-keyword">if</span> (<span class="syntax-all syntax-keyword">!</span><span class="syntax-all syntax-parameter">event</span>) {
        <span class="syntax-all syntax-keyword">return</span>;
      }

      <span class="syntax-all syntax-keyword">if</span> (<span class="syntax-all syntax-parameter">event</span><span class="syntax-all syntax-keyword">.</span><span class="syntax-all syntax-parameter">stopPropagation</span>) {
        <span class="syntax-all syntax-parameter">event</span><span class="syntax-all syntax-keyword">.</span><span class="syntax-all syntax-variable">stopPropagation</span>();
      } <span class="syntax-all syntax-keyword">else</span> <span class="syntax-all syntax-keyword">if</span> (<span class="syntax-all syntax-keyword">typeof</span> <span class="syntax-all syntax-parameter">event</span><span class="syntax-all syntax-keyword">.</span><span class="syntax-all syntax-parameter">cancelBubble</span> <span class="syntax-all syntax-keyword">!==</span> <span class="syntax-all syntax-string">&#39;unknown&#39;</span>) {
        <span class="syntax-all syntax-parameter">event</span><span class="syntax-all syntax-keyword">.</span><span class="syntax-all syntax-parameter">cancelBubble</span> <span class="syntax-all syntax-keyword">=</span> <span class="syntax-all syntax-constant">true</span>;
      }

      <span class="syntax-all syntax-constant">this</span><span class="syntax-all syntax-keyword">.</span><span class="syntax-all syntax-parameter">isPropagationStopped</span> <span class="syntax-all syntax-keyword">=</span> <span class="syntax-all syntax-parameter">functionThatReturnsTrue</span>;
    },</code></pre>

<pre><code class="code-highlighted code-js">    <span class="syntax-all syntax-comment">// éå†æ‰§è¡Œæ¨¡æ‹Ÿå‡ºæ¥çš„ bubble path çš„ onclick äº‹ä»¶
</span>	<span class="syntax-all syntax-keyword">if</span> (<span class="syntax-all syntax-constant">Array</span><span class="syntax-all syntax-keyword">.</span><span class="syntax-all syntax-variable">isArray</span>(<span class="syntax-all syntax-parameter">dispatchListeners</span>)) {
      <span class="syntax-all syntax-keyword">for</span> (<span class="syntax-all syntax-keyword">var</span> <span class="syntax-all syntax-parameter">i</span> <span class="syntax-all syntax-keyword">=</span> <span class="syntax-all syntax-constant">0</span>; <span class="syntax-all syntax-parameter">i</span> <span class="syntax-all syntax-keyword">&lt;</span> <span class="syntax-all syntax-parameter">dispatchListeners</span><span class="syntax-all syntax-keyword">.</span><span class="syntax-all syntax-parameter">length</span>; <span class="syntax-all syntax-parameter">i</span><span class="syntax-all syntax-keyword">++</span>) {
        <span class="syntax-all syntax-keyword">if</span> (<span class="syntax-all syntax-parameter">event</span><span class="syntax-all syntax-keyword">.</span><span class="syntax-all syntax-variable">isPropagationStopped</span>()) {
          <span class="syntax-all syntax-keyword">break</span>;
        } <span class="syntax-all syntax-comment">// Listeners and Instances are two parallel arrays that are always in sync.
</span>

        <span class="syntax-all syntax-variable">executeDispatch</span>(<span class="syntax-all syntax-parameter">event</span>, <span class="syntax-all syntax-parameter">dispatchListeners</span>[<span class="syntax-all syntax-parameter">i</span>], <span class="syntax-all syntax-parameter">dispatchInstances</span>[<span class="syntax-all syntax-parameter">i</span>]);
      }
    } <span class="syntax-all syntax-keyword">else</span> <span class="syntax-all syntax-keyword">if</span> (<span class="syntax-all syntax-parameter">dispatchListeners</span>) {
      <span class="syntax-all syntax-variable">executeDispatch</span>(<span class="syntax-all syntax-parameter">event</span>, <span class="syntax-all syntax-parameter">dispatchListeners</span>, <span class="syntax-all syntax-parameter">dispatchInstances</span>);
    }</code></pre>

<p>æ‰§è¡Œå®Œäº†ä¹‹åï¼Œè“è‰²çš„æ¡†æ¡†ä¹ŸåŒæ ·å’Œçº¢è‰²çš„æ¡†æ¡†èµ°ä¸€éæµç¨‹ï¼Œæ‰€ä»¥ï¼Œè“è‰²çš„æ¡†æ¡†é‡Œçš„ <code>onclick</code> event handler è°ƒç”¨ <code>e.stopPropagation()</code> ä¸ç”Ÿæ•ˆçš„åŸå› æ˜¯ï¼Œçº¢è‰²æ¡†æ¡†åœ¨æ‰§è¡Œè“è‰²çš„æ¨¡æ‹Ÿäº‹ä»¶é˜Ÿåˆ—å‰å°±å·²ç»æ‰§è¡Œäº†ã€‚</p>

<p>React 17 æ¥äº†ï¼Œè§£å†³äº†è¿™ä¸ªé—®é¢˜ã€‚</p>

<h3>React 17</h3>

<p>åŠæ³•ä¹Ÿå¾ˆç®€å•ï¼Œå°±æ˜¯åœ¨åŸæ¥åœ¨ <strong> document</strong> èŠ‚ç‚¹æ·»åŠ æ€»çš„ event listenerï¼Œç°åœ¨åœ¨ <strong>react DOM root node</strong> æ·»åŠ ã€‚</p>

<p>è¿™æ ·å¯ä»¥è§£å†³é—®é¢˜å—ï¼Ÿ</p>

<p>èŠ±äº”åˆ†é’Ÿæƒ³ä¸‹ã€‚</p>

<p>æˆ‘ä»¬å°†é‡Œé¢çš„è“è‰²æ¡†æ¡†æ‰€ç”¨çš„ React 16 çš„åº“æ›¿æ¢ä¸º React 17 çš„ï¼Œå¤–é¢çš„è¿˜æ˜¯ React 16 çš„ï¼Œé€»è¾‘ä¸å˜ï¼Œæ¥çœ‹ä¸‹ <a href="https://react-17-nested-tree-demo.netlify.app/">demo</a>ï¼Œ</p>

<figure><img src="DraggedImage-3.png"/></figure>

<p><strong>ç°åœ¨åªä¼šæ‰“å°æœ€é‡Œé¢çš„äº†</strong>ã€‚WOWï½</p>

<p>æ¥çœ‹ä¸‹å‘ç”Ÿäº†ä»€ä¹ˆã€‚</p>

<p>åœ¨å†…éƒ¨çš„è“è‰²æ¡†æ¡†é‡Œï¼Œåœ¨ç‚¹å‡»åï¼Œé¦–å…ˆè“è‰²æ¡†æ¡†çš„ç‚¹å‡»äº‹ä»¶ bubble åˆ°äº†è“è‰²æ¡†æ¡†çš„ React DOM root èŠ‚ç‚¹ï¼Œç„¶å React DOM root èŠ‚ç‚¹çš„ <code>click</code> event handler å°±è¢«è°ƒç”¨äº†ï¼Œè°ƒç”¨çš„æ—¶å€™å¼€å§‹æ¨¡æ‹Ÿåˆæˆäº‹ä»¶é˜Ÿåˆ—ï¼Œç„¶åæ‰§è¡Œï¼Œé˜Ÿåˆ—é‡Œçš„ç°åœ¨å°±ä¸€ä¸ª event handlerï¼Œå°±æ˜¯è“è‰²æ¡†æ¡†çš„ï¼Œç„¶åæ‰§è¡Œå°±è§¦å‘äº† <code>e.stopPropagation();</code>ï¼Œè¿™æ—¶ï¼ŒReact DOM å…ˆæ˜¯è°ƒç”¨äº† <em>native event</em> çš„ <code>e.stopPropagation();</code>ï¼Œä¿è¯äº† è“è‰²æ¡†æ¡†çš„ React DOM root çš„ <em>native event </em>ä¸ä¼šç»§ç»­ bubble ä¸Šå»äº†ï¼ˆæ‰€ä»¥å°±åˆ°ä¸äº†çº¢è‰²æ¡†æ¡†äº†ï¼‰ï¼Œç„¶åå°†å†åœ¨åŒ…äº† <em>native event</em> ä¸€å±‚çš„ Synthetic Eventï¼ˆåˆæˆäº‹ä»¶ï¼‰ä¸Šçš„ <em> isDefaultPrevented</em> è®¾ä¸º <em>true</em>ï¼Œè¿™æ ·å†…éƒ¨çš„äº‹ä»¶é˜Ÿåˆ—åœ¨è¿™ä¸ª event handler è°ƒç”¨åï¼Œåé¢çš„ä¹Ÿä¸ä¼šè°ƒç”¨äº†ï¼ˆè™½ç„¶ç°åœ¨å°±åªæœ‰ä¸€ä¸ª</p>

<p>ä»¥ä¸Šã€‚</p>

<p><strong>é¢˜å¤–è¯</strong>ï¼šè·‘ demo æ‰“æ–­ç‚¹çœ‹é€»è¾‘çš„æ—¶å€™ï¼Œå‘ç° Chrome åœ¨æ‰“æ–­ç‚¹çš„æ—¶å€™å’Œä¸æ‰“æ–­ç‚¹çš„æ—¶å€™è·‘çš„ <a href="https://react-16-nest-react-16.netlify.app/">React V16 nested demo</a> demo ç«Ÿç„¶ç»“æœæ˜¯ä¸ä¸€æ ·çš„ã€‚ã€‚ã€‚ Safari åˆ°æ²¡äº‹ã€‚ã€‚ã€‚</p>

<h3>å‚è€ƒæ–‡çŒ®</h3>

<ol>
	<li><a href="https://javascript.info/bubbling-and-capturing">Bubbling and capturing</a></li>
	<li><a href="https://www.w3.org/TR/DOM-Level-3-Events/#current-event-target">current event target</a></li>
	<li><a href="https://www.w3.org/TR/DOM-Level-3-Events/#event-target">event target</a></li>
	<li><a href="https://www.w3.org/TR/DOM-Level-3-Events/#dom-event-architecture">Event dispatch and DOM event flow</a></li>
	<li><a href="https://reactjs.org/blog/2020/08/10/react-v17-rc.html#changes-to-event-delegation">React 17 changes-to-event-delegation - React official doc</a></li>
	<li><a href="https://reactjs.org/docs/handling-events.html">Handling Events - React official doc</a></li>
	<li><a href="https://maddevs.io/insights/blog/a-bit-about-event-delegation-in-react/">A Bit about Event Delegation in React â˜… â˜… â˜… â˜… â˜…</a></li>
	<li><a href="https://davidwalsh.name/event-delegate">How JavaScript Event Delegation Works â˜… â˜… â˜… â˜… â˜…</a></li>
	<li><a href="https://reactjs.org/docs/events.html">SyntheticEvent - React official doc</a></li>
	<li><a href="https://github.com/facebook/react/pull/8117">Nested React Dom Tree Issue(atom editor) - GitHub issue</a></li>
	<li><a href="https://github.com/facebook/react/issues/7094#issuecomment-228931737">Event delegation issue - Global event handlers on document.body (or other containing element) run BEFORE react event handlers #7094 - gaearon</a></li>
	<li><a href="https://reactjs.org/docs/testing-recipes.html#events">Testing in React event part - React official doc</a></li>
	<li><a href="https://developer.mozilla.org/en-US/docs/Web/API/EventTarget/addEventListener">EventTarget.addEventListener()</a></li>
	<li><a href="https://tumiblog.top/blogs/JavaScript/JS%20%E4%BA%8B%E4%BB%B6%E5%86%92%E6%B3%A1%E3%80%81%E6%8D%95%E8%8E%B7%E4%B8%8E%E4%BA%8B%E4%BB%B6%E5%A7%94%E6%89%98.html"> ä¸ºä»€ä¹ˆä½¿ç”¨å†’æ³¡æ¥å®ç°äº‹ä»¶å§”æ‰˜å±…å¤š?</a></li>
</ol>

</body>
</html>

